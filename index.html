<!DOCTYPE html>
<meta charset="utf-8">
<style>

.border {
	fill:#ddd;
	stroke: black;
}
</style>

<body>
<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script>

var width = 1200,
    height = 960;

	
var projection = d3.geo.conicConformal()
							.rotate([98, 0])
						    .center([-25.9, 49.12])//sides
						    .parallels([-75, 80.5]) //top and bottom
						    .scale(1)
						    .translate([0,0]);

var path = d3.geo.path()
    .projection(projection);

// setup canvas
var svg = d3.select("body")
	.append("svg")
    .attr("width", width)
    .attr("height", height);

// setup scale for colour coding contours
var cScale = d3.scale.linear()
	.domain([0,1]);

// var test;
// d3.json("nanaimo.json", function(error, nanaimo) {
// 	if (error) return console.error(error);
	 
// 	svg.append("path")
// 		.datum(topojson.mesh(nanaimo))
// 		.attr("d", path);
// });
var feature;
// read in topojson file
d3.json("merged.json", function(error, merged) {
	if (error) return console.error(error);

	// first variable is used to center and scale map the viewport
	var bTopo = topojson.feature(merged, merged.objects.contours),
		topo = bTopo.features;
		feature = topo;
	// calculate the range for colors basend on the elevation property
	var hRange = d3.extent(topo, function(d,i ) {
		return d.properties.elevation
	});

	cScale.domain(hRange);

	// calculate bounds, scale and transform
    // see http://stackoverflow.com/questions/14492284/center-a-map-in-d3-given-a-geojson-object
    var b = path.bounds(bTopo),
    	s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height),
        t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2];

	projection.scale(s)
		.translate(t)

	svg.selectAll("path")
		.data(topo)
		.enter()
		.append("path")
		.style("fill", "none")
		.style("stroke", function(d, i) {
			if (d.properties.elevation < 40) {return "steelblue"}
				else
				{return interp(cScale(d.properties.elevation))};
		})
		.attr("d", path)        
        .on("mouseover", highlight) // just a little example of what's available in terms of interaction
        .on("mouseout", function (d,i) {unhighlight(this,d); 
        });

});


// function to interpolate between to colours
// see http://stackoverflow.com/questions/12217121/continuous-color-scale-from-discrete-domain-of-strings

function interp(x) {
    var ans = d3.interpolateLab("#ffffe5", "#004529")(x);
    return ans
}
// A simple highlight example
function highlight(x) {

    var s = d3.select(this);

    s.style("stroke", "red");

}
function unhighlight(x,y) {

    var old = y.properties.elevation;
    var u = d3.select(x);

    u.style("stroke", function(d, i) {
            return interp(cScale(old));
        })
}

</script>
</body>
</html>